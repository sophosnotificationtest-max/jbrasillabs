<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JBrasil Labs - Cyber Defense 3D</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r155/three.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
body, html {
    margin:0;
    padding:0;
    width:100%;
    height:100%;
    overflow:hidden;
    background:#000;
    font-family:'Orbitron',sans-serif;
    cursor:none;
}

canvas { display:block; }

.glitch-active {
    animation: glitch 0.2s infinite;
    filter: hue-rotate(90deg) contrast(1.5);
}

@keyframes glitch {
    0% { transform: translate(0); }
    50% { transform: translate(-4px,4px); }
    100% { transform: translate(0); }
}

.hud {
    position:fixed;
    top:20px;
    left:20px;
    z-index:100;
    font-family:'Press Start 2P',cursive;
    font-size:10px;
    color:#00ff00;
    text-shadow:0 0 10px #00ff00;
}

#start-screen {
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    background:black;
    z-index:200;
}

.start-btn {
    font-family:'Press Start 2P',cursive;
    color:#00ff00;
    font-size:16px;
    margin-top:40px;
    animation: blink 1s infinite;
    cursor:pointer;
}

@keyframes blink {
    50% { opacity:0; }
}
</style>
</head>

<body>

<div class="hud" id="hud" style="display:none;">
SCORE: <span id="score">0000</span><br>
LEAKS: <span id="leaks">0</span>/30
</div>

<div id="start-screen">
<h1 style="color:#00ff00;font-size:40px;">JBrasil Labs</h1>
<div class="start-btn" id="start-btn">INITIALIZE DEFENSE</div>
</div>

<script>

// ---------------- AUDIO ----------------
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(freq,type,dur){
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type=type;
    osc.frequency.value=freq;
    gain.gain.value=0.1;
    gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+dur);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime+dur);
}

// ---------------- THREE 3D ----------------
let scene, camera, renderer;
let ship;
let enemies=[];
let bullets=[];
let stars=[];
let score=0;
let leaks=0;
let gameActive=false;

function init3D(){

    scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x000000,20,200);

    camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth/window.innerHeight,
        0.1,
        1000
    );
    camera.position.z = 40;

    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth,window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    // Luz
    const light = new THREE.PointLight(0x00ffcc,2,200);
    light.position.set(0,20,50);
    scene.add(light);

    const ambient = new THREE.AmbientLight(0x111111);
    scene.add(ambient);

    // Nave
    const shipGeo = new THREE.ConeGeometry(2,6,32);
    const shipMat = new THREE.MeshStandardMaterial({
        color:0x00ff00,
        emissive:0x003300,
        metalness:0.6,
        roughness:0.4
    });
    ship = new THREE.Mesh(shipGeo,shipMat);
    ship.rotation.x = Math.PI/2;
    scene.add(ship);

    // Fundo estrelas
    const starGeo = new THREE.SphereGeometry(0.2,8,8);
    const starMat = new THREE.MeshBasicMaterial({color:0xffffff});
    for(let i=0;i<300;i++){
        const star = new THREE.Mesh(starGeo,starMat);
        star.position.set(
            (Math.random()-0.5)*200,
            (Math.random()-0.5)*200,
            (Math.random()-0.5)*200
        );
        scene.add(star);
        stars.push(star);
    }

    window.addEventListener('mousemove',(e)=>{
        ship.position.x = (e.clientX/window.innerWidth)*40 -20;
        ship.position.y = -(e.clientY/window.innerHeight)*25 +12;
    });

    window.addEventListener('resize',onResize);
}

function onResize(){
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
}

// -------- INIMIGO --------
function spawnEnemy(){
    const geo = new THREE.IcosahedronGeometry(2,0);
    const mat = new THREE.MeshStandardMaterial({
        color:0xff0040,
        emissive:0x330000
    });
    const enemy = new THREE.Mesh(geo,mat);
    enemy.position.set((Math.random()-0.5)*40,20,0);
    enemy.speed = 0.1 + (score/2000);
    scene.add(enemy);
    enemies.push(enemy);
}

// -------- TIRO --------
function shoot(){
    if(!gameActive) return;

    const geo = new THREE.CylinderGeometry(0.2,0.2,4);
    const mat = new THREE.MeshBasicMaterial({color:0x4e9eff});
    const bullet = new THREE.Mesh(geo,mat);
    bullet.rotation.x = Math.PI/2;
    bullet.position.copy(ship.position);
    bullet.speed=1;
    scene.add(bullet);
    bullets.push(bullet);

    playSound(440,'square',0.1);
}

window.addEventListener('mousedown',shoot);
window.addEventListener('keydown',e=>{
    if(e.code==="Space") shoot();
});

// -------- LOOP --------
function animate(){
    requestAnimationFrame(animate);

    if(gameActive){

        if(Math.random()<0.02+(score/20000)){
            spawnEnemy();
        }

        bullets.forEach((b,bi)=>{
            b.position.y += b.speed;

            enemies.forEach((e,ei)=>{
                if(b.position.distanceTo(e.position)<2.5){
                    scene.remove(e);
                    scene.remove(b);
                    enemies.splice(ei,1);
                    bullets.splice(bi,1);
                    score+=10;
                    document.getElementById('score').innerText =
                        score.toString().padStart(4,'0');
                    playSound(150,'sine',0.05);
                }
            });

            if(b.position.y>30){
                scene.remove(b);
                bullets.splice(bi,1);
            }
        });

        enemies.forEach((e,i)=>{
            e.position.y -= e.speed;
            e.rotation.x+=0.02;
            e.rotation.y+=0.02;

            if(e.position.y<-20){
                scene.remove(e);
                enemies.splice(i,1);
                leaks++;
                document.getElementById('leaks').innerText=leaks;
                document.body.classList.add('glitch-active');
                setTimeout(()=>document.body.classList.remove('glitch-active'),200);

                if(leaks>=30){
                    systemReboot();
                }
            }
        });

    }

    renderer.render(scene,camera);
}

function systemReboot(){
    gameActive=false;
    leaks=0;
    score=0;
    enemies.forEach(e=>scene.remove(e));
    bullets.forEach(b=>scene.remove(b));
    enemies=[];
    bullets=[];
    document.getElementById('score').innerText="0000";
    document.getElementById('leaks').innerText="0";
    document.getElementById('hud').style.display='none';
    document.getElementById('start-screen').style.display='flex';
}

document.getElementById('start-btn').addEventListener('click',()=>{
    audioCtx.resume();
    document.getElementById('start-screen').style.display='none';
    document.getElementById('hud').style.display='block';
    gameActive=true;
});

init3D();
animate();

</script>

</body>
</html>
