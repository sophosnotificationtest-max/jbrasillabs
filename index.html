<script>
// =======================
// ðŸŽµ AUDIO ENGINE
// =======================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function sfx(freq,type,duration,vol=0.1){
    if(audioCtx.state==="suspended") audioCtx.resume();
    const osc=audioCtx.createOscillator();
    const gain=audioCtx.createGain();
    osc.type=type;
    osc.frequency.setValueAtTime(freq,audioCtx.currentTime);
    gain.gain.setValueAtTime(vol,audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+duration);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime+duration);
}

// =======================
// ðŸŽ® CORE
// =======================
const bgCanvas=document.getElementById("bg-space");
const gCanvas=document.getElementById("game-layer");
const sCtx=bgCanvas.getContext("2d");
const gCtx=gCanvas.getContext("2d");

let score=0,lives=3,gameRunning=false,tick=0;
let enemies=[],bullets=[],particles=[],explosions=[];
let boss=null;
let mouseX=innerWidth/2,mouseY=innerHeight/2;
let overdrive=false,overdriveTimer=0;

// =======================
// ðŸŒŒ BACKGROUND
// =======================
let stars=[];
function init(){
    bgCanvas.width=gCanvas.width=innerWidth;
    bgCanvas.height=gCanvas.height=innerHeight;
    stars=[];
    for(let i=0;i<300;i++){
        stars.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,s:Math.random()*2});
    }
}
init();
window.addEventListener("resize",init);

// =======================
// ðŸš€ PLAYER
// =======================
function drawPlayer(){
    gCtx.save();
    gCtx.translate(mouseX,mouseY);

    let glow = overdrive ? "#ff0" : "#0ff";
    gCtx.shadowBlur=20;
    gCtx.shadowColor=glow;
    gCtx.strokeStyle=glow;
    gCtx.lineWidth=2;

    gCtx.beginPath();
    gCtx.moveTo(0,-20);
    gCtx.lineTo(15,10);
    gCtx.lineTo(0,5);
    gCtx.lineTo(-15,10);
    gCtx.closePath();
    gCtx.stroke();

    gCtx.fillStyle=glow;
    gCtx.globalAlpha=0.6+Math.sin(tick*0.2)*0.3;
    gCtx.beginPath();
    gCtx.arc(0,0,6,0,Math.PI*2);
    gCtx.fill();

    gCtx.restore();
    gCtx.globalAlpha=1;
    gCtx.shadowBlur=0;

    // PropulsÃ£o
    for(let i=0;i<2;i++){
        particles.push({
            x:mouseX+(Math.random()*6-3),
            y:mouseY+15,
            vx:(Math.random()-0.5)*1,
            vy:2+Math.random()*2,
            life:1,
            color:glow
        });
    }
}

// =======================
// ðŸ‘¾ ENEMY
// =======================
function spawnEnemy(){
    enemies.push({
        x:Math.random()*innerWidth,
        y:-40,
        size:20+Math.random()*10,
        speed:2+score/1000,
        rot:0,
        hit:false
    });
}

function drawEnemy(e){
    gCtx.save();
    gCtx.translate(e.x,e.y);
    gCtx.rotate(e.rot);

    gCtx.strokeStyle=e.hit?"#fff":"#f33";
    gCtx.lineWidth=2;
    gCtx.shadowBlur=15;
    gCtx.shadowColor="#f00";

    gCtx.beginPath();
    gCtx.moveTo(0,-e.size);
    gCtx.lineTo(e.size,e.size);
    gCtx.lineTo(-e.size,e.size);
    gCtx.closePath();
    gCtx.stroke();

    gCtx.restore();
    gCtx.shadowBlur=0;
    e.hit=false;
}

// =======================
// ðŸ’¥ EXPLOSION
// =======================
function explode(x,y){
    for(let i=0;i<25;i++){
        explosions.push({
            x,y,
            vx:(Math.random()-0.5)*8,
            vy:(Math.random()-0.5)*8,
            life:1
        });
    }
    sfx(120,"sawtooth",0.2,0.2);
}

// =======================
// ðŸ‘‘ BOSS
// =======================
function spawnBoss(){
    boss={
        x:innerWidth/2,
        y:120,
        health:300,
        phase:1
    };
}

function drawBoss(){
    gCtx.save();
    gCtx.translate(boss.x,boss.y);
    gCtx.strokeStyle="#ff00ff";
    gCtx.lineWidth=4;
    gCtx.shadowBlur=25;
    gCtx.shadowColor="#ff00ff";
    gCtx.beginPath();
    gCtx.arc(0,0,60,0,Math.PI*2);
    gCtx.stroke();
    gCtx.restore();
    gCtx.shadowBlur=0;
}

// =======================
// ðŸŽ® LOOP
// =======================
function loop(){
    tick++;

    // Background
    sCtx.fillStyle="#000";
    sCtx.fillRect(0,0,innerWidth,innerHeight);
    stars.forEach(st=>{
        sCtx.fillStyle="#fff";
        sCtx.fillRect(st.x,st.y,st.s,st.s);
    });

    gCtx.clearRect(0,0,innerWidth,innerHeight);

    if(gameRunning){

        if(tick%40===0) spawnEnemy();

        if(score>1000 && !boss) spawnBoss();

        bullets.forEach((b,i)=>{
            b.y-=b.speed;
            gCtx.fillStyle="#fff";
            gCtx.fillRect(b.x,b.y,4,15);
            if(b.y<0) bullets.splice(i,1);
        });

        enemies.forEach((e,i)=>{
            e.y+=e.speed;
            e.rot+=0.05;
            drawEnemy(e);

            if(e.y>innerHeight){
                lives--;
                document.body.style.background="#200";
                setTimeout(()=>document.body.style.background="#000",100);
                enemies.splice(i,1);
                if(lives<=0) endGame();
            }

            bullets.forEach((b,bi)=>{
                if(Math.hypot(b.x-e.x,b.y-e.y)<e.size){
                    score+=10;
                    e.hit=true;
                    explode(e.x,e.y);
                    enemies.splice(i,1);
                    bullets.splice(bi,1);
                }
            });
        });

        if(boss){
            drawBoss();
            bullets.forEach((b,bi)=>{
                if(Math.hypot(b.x-boss.x,b.y-boss.y)<60){
                    boss.health-=5;
                    bullets.splice(bi,1);
                    if(boss.health<=0){
                        score+=500;
                        explode(boss.x,boss.y);
                        boss=null;
                        overdrive=true;
                        overdriveTimer=300;
                    }
                }
            });
        }

        if(overdrive){
            overdriveTimer--;
            if(overdriveTimer<=0) overdrive=false;
        }
    }

    // Particles
    particles.forEach((p,i)=>{
        p.x+=p.vx;
        p.y+=p.vy;
        p.life-=0.04;
        gCtx.fillStyle=`rgba(0,255,255,${p.life})`;
        gCtx.fillRect(p.x,p.y,3,3);
        if(p.life<=0) particles.splice(i,1);
    });

    explosions.forEach((ex,i)=>{
        ex.x+=ex.vx;
        ex.y+=ex.vy;
        ex.life-=0.03;
        gCtx.fillStyle=`rgba(255,100,0,${ex.life})`;
        gCtx.fillRect(ex.x,ex.y,4,4);
        if(ex.life<=0) explosions.splice(i,1);
    });

    drawPlayer();

    document.getElementById("score").innerText=score.toString().padStart(4,"0");
    document.getElementById("lives").innerText=(lives*33.3).toFixed(0)+"%";

    requestAnimationFrame(loop);
}
loop();

// =======================
// ðŸ–± CONTROLES
// =======================
window.addEventListener("mousemove",e=>{
    mouseX=e.clientX;
    mouseY=e.clientY;
});

window.addEventListener("mousedown",()=>{
    if(gameRunning){
        bullets.push({x:mouseX,y:mouseY,speed: overdrive?25:18});
        sfx(800,"triangle",0.1,0.1);
    }
});

// =======================
// ðŸŽ® GAME CONTROL
// =======================
function startGame(){
    document.getElementById("start-screen").style.display="none";
    score=0;lives=3;enemies=[];bullets=[];boss=null;
    gameRunning=true;
}

function endGame(){
    gameRunning=false;
    document.getElementById("game-over-screen").style.display="flex";
    document.getElementById("final-score").innerText=score;
    sfx(60,"sine",1,0.3);
}
</script>
