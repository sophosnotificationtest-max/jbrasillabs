<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JBrasil Labs - Cyber SOC Defense</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; cursor: none; color: #00ff00; }
        canvas { position: fixed; inset: 0; z-index: 1; }
        #bg-stars { z-index: 0; }
        
        .hud { position: fixed; top: 20px; left: 20px; z-index: 100; font-family: 'Press Start 2P', cursive; font-size: 10px; line-height: 2.5; pointer-events: none; }
        
        /* Terminal GeoIP */
        #geo-terminal { position: fixed; bottom: 80px; left: 20px; z-index: 200; font-family: monospace; font-size: 11px; color: #00ff00; text-shadow: 0 0 5px #00ff00; background: rgba(0,20,0,0.7); padding: 12px; border-left: 3px solid #00ff00; min-width: 280px; box-shadow: 0 0 15px rgba(0,255,0,0.2); }

        #overlay { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.85); z-index: 300; transition: opacity 0.8s; }
        #main-logo { width: 550px; max-width: 85%; filter: drop-shadow(0 0 30px #00ff00); margin-bottom: 40px; transition: 0.5s; }
        #main-logo:hover { filter: drop-shadow(0 0 50px #00ff00); transform: scale(1.02); }
        
        .prompt { font-family: 'Press Start 2P', cursive; font-size: 16px; animation: blink 1s infinite; cursor: pointer; border: 1px solid #00ff00; padding: 15px 30px; background: rgba(0,255,0,0.1); transition: 0.3s; }
        .prompt:hover { background: #00ff00; color: #000; box-shadow: 0 0 20px #00ff00; }
        
        #footer-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,15,0,0.95); border-top: 1px solid #00ff0033; padding: 10px 20px; z-index: 100; display: flex; justify-content: space-between; align-items: center; font-size: 10px; letter-spacing: 1px; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>

<canvas id="bg-stars"></canvas>
<canvas id="game-layer"></canvas>

<div class="hud" id="game-hud" style="display: none;">
    SCORE: <span id="score">0</span><br>
    BREACHES: <span id="leaks">0</span>/30
</div>

<div id="geo-terminal">
    > [SYSTEM] INITIALIZING DEFENSE CORE...<br>
    > [SOC] SCANNING SOURCE IP...
</div>

<div id="overlay">
    <img src="https://raw.githubusercontent.com/sophosnotificationtest-max/jbrasillabs/main/logo.png" id="main-logo">
    <div class="prompt" id="start-btn">INITIALIZE DEFENSE</div>
    <div style="margin-top: 25px; color: #4e9eff; font-size: 11px; letter-spacing: 3px; font-weight: bold;">SOPHOS CERTIFIED SPECIALIST</div>
</div>

<div id="footer-bar">
    <div>JBRASIL LABS // NETWORK DEFENSE UNIT</div>
    <div style="color: #4e9eff;">SECURE CONNECTION: AES-256</div>
</div>

<script>
const starCanvas = document.getElementById("bg-stars");
const sCtx = starCanvas.getContext("2d");
const gameCanvas = document.getElementById("game-layer");
const gCtx = gameCanvas.getContext("2d");

let score = 0, leaks = 0, gameRunning = false, userLocation = "UNKNOWN";
let stars = [], particles = [], enemies = [], bullets = [], mouseParticles = [];
let mouseX = innerWidth/2, mouseY = innerHeight/2;

function resize() {
    starCanvas.width = gameCanvas.width = innerWidth;
    starCanvas.height = gameCanvas.height = innerHeight;
    initStars();
}
window.addEventListener("resize", resize);
resize();

// --- Efeito Gal√°xia (Space Move) ---
function initStars() {
    stars = [];
    for(let i=0; i<250; i++) {
        stars.push({ x: Math.random()*innerWidth, y: Math.random()*innerHeight, z: Math.random()*innerWidth });
    }
}

function drawGalaxy() {
    sCtx.fillStyle = "black";
    sCtx.fillRect(0, 0, innerWidth, innerHeight);
    stars.forEach(s => {
        s.z -= 1.5;
        if(s.z <= 0) s.z = innerWidth;
        let sx = (s.x - innerWidth/2) * (innerWidth/s.z) + innerWidth/2;
        let sy = (s.y - innerHeight/2) * (innerWidth/s.z) + innerHeight/2;
        let size = (1 - s.z/innerWidth) * 2.5;
        sCtx.fillStyle = `rgba(255, 255, 255, ${1 - s.z/innerWidth})`;
        sCtx.fillRect(sx, sy, size, size);
    });
}

// --- Rastro de Dados do Mouse ---
class MouseTrail {
    constructor(x, y) {
        this.x = x; this.y = y;
        this.size = Math.random() * 3 + 1;
        this.life = 1;
        this.vx = (Math.random()-0.5)*1.5;
        this.vy = (Math.random()-0.5)*1.5;
    }
    update() { this.x+=this.vx; this.y+=this.vy; this.life -= 0.02; }
    draw(ctx) {
        ctx.fillStyle = `rgba(0, 255, 0, ${this.life})`;
        ctx.fillRect(this.x, this.y, this.size, this.size);
    }
}

// --- L√≥gica do Jogo ---
class Enemy {
    constructor() {
        this.x = Math.random() * (innerWidth-60)+30; this.y = -30;
        this.speed = 1.6 + (score/2500);
    }
    draw() { gCtx.font = "26px Arial"; gCtx.fillText("üëæ", this.x-13, this.y+10); }
}

class Bullet {
    constructor(x, y) { this.x = x; this.y = y-20; this.speed = 20; }
    draw() { gCtx.fillStyle = "#00ffff"; gCtx.fillRect(this.x-1, this.y, 2, 18); }
}

addEventListener("mousemove", e => { 
    mouseX = e.clientX; mouseY = e.clientY; 
    mouseParticles.push(new MouseTrail(mouseX, mouseY));
});

function gameLoop() {
    drawGalaxy();
    gCtx.clearRect(0,0,innerWidth,innerHeight);

    mouseParticles.forEach((p, i) => {
        p.update(); p.draw(gCtx);
        if(p.life <= 0) mouseParticles.splice(i, 1);
    });

    if(gameRunning) {
        if(Math.random() < 0.035 + (score/30000)) enemies.push(new Enemy());
        bullets.forEach((b, bi) => {
            b.y -= b.speed; b.draw();
            if(b.y < 0) bullets.splice(bi, 1);
        });
        enemies.forEach((e, ei) => {
            e.y += e.speed; e.draw();
            if(e.y > innerHeight) { 
                leaks++; enemies.splice(ei, 1); 
                if(leaks>=30) { gameRunning = false; document.getElementById("overlay").style.display = "flex"; }
            }
            bullets.forEach((b, bi) => {
                if(Math.hypot(e.x - b.x, e.y - b.y) < 25) {
                    score += 10; enemies.splice(ei, 1); bullets.splice(bi, 1);
                }
            });
        });
        // Nave
        gCtx.save(); gCtx.translate(mouseX, mouseY);
        gCtx.strokeStyle = "#00ff00"; gCtx.lineWidth = 2;
        gCtx.beginPath(); gCtx.moveTo(0, -20); gCtx.lineTo(-15, 12); gCtx.lineTo(0, 4); gCtx.lineTo(15, 12); gCtx.closePath(); gCtx.stroke();
        gCtx.restore();
    }
    document.getElementById("score").innerText = score;
    document.getElementById("leaks").innerText = leaks;
    requestAnimationFrame(gameLoop);
}

// --- GeoIP e Envio de Logs ---
function updateTerminal(msg) {
    const term = document.getElementById("geo-terminal");
    term.innerHTML += `<br>> ${msg}`;
}

async function startSystem() {
    // 1. Identifica o IP imediatamente ao carregar
    try {
        const res = await fetch('https://jbrasillabs-1.onrender.com/geoip');
        const data = await res.json();
        userLocation = data.entry;
        updateTerminal(`[SOC] LOCATION DETECTED: ${userLocation.toUpperCase()}`);
    } catch(e) { updateTerminal("[!] FAILOVER: SECURE NODE ACTIVE"); }
}

document.getElementById("start-btn").onclick = async () => {
    // 2. Envia o LOG para o Sheets no clique do bot√£o
    updateTerminal("[SOC] SENDING SESSION LOG...");
    
    fetch('https://jbrasillabs-1.onrender.com/log', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ entry: userLocation })
    }).then(() => updateTerminal("[SOC] LOG SYNCHRONIZED."))
      .catch(() => updateTerminal("[!] LOG OFFLINE - LOCAL ONLY"));

    // Inicia o Jogo
    document.getElementById("overlay").style.display = "none";
    document.getElementById("game-hud").style.display = "block";
    score = 0; leaks = 0; enemies = []; bullets = [];
    gameRunning = true;
};

addEventListener("mousedown", () => { if(gameRunning) bullets.push(new Bullet(mouseX, mouseY)); });

startSystem();
gameLoop();
</script>
</body>
</html>
