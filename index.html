<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JBrasil Labs - SOC Level System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Press Start 2P', cursive; cursor: none; color: #00ff00; }
        canvas { position: fixed; inset: 0; }
        #bg-space { z-index: 0; }
        #game-layer { z-index: 1; image-rendering: pixelated; }
        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, -2px, 0); } 20%, 80% { transform: translate3d(4px, 4px, 0); } 30%, 50%, 70% { transform: translate3d(-6px, -6px, 0); } }
        .hud { position: fixed; top: 20px; left: 20px; z-index: 100; font-size: 10px; color: #fff; text-shadow: 0 0 10px #00ff00; line-height: 1.8; pointer-events: none; }
        #leaderboard-fixed { position: fixed; top: 20px; right: 20px; z-index: 100; font-size: 8px; color: #4e9eff; background: rgba(0,0,0,0.85); padding: 15px; border: 1px solid rgba(0,255,0,0.3); text-align: right; backdrop-filter: blur(5px); pointer-events: none; }
        .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.9); z-index: 300; }
        .btn-ui { font-size: 12px; cursor: pointer; border: 3px solid #00ff00; padding: 15px 30px; background: transparent; color: #00ff00; transition: 0.3s; pointer-events: auto; }
        .btn-ui:hover:not(.disabled) { background: #00ff00; color: #000; }
        .btn-ui.disabled { opacity: 0.3; cursor: wait; }
    </style>
</head>
<body id="main-body">

<canvas id="bg-space"></canvas>
<canvas id="game-layer"></canvas>

<div class="hud">
    SCORE: <span id="score-val">0000</span><br>
    LEVEL: <span id="level-val">1</span><br>
    SHIELD: <span id="lives-val">100%</span><br>
    WEAPON: <span id="weapon-status" style="color: #0ff;">STANDARD</span>
</div>

<div id="leaderboard-fixed">
    <div style="font-weight: bold; margin-bottom: 10px; color: #00ff00;">TOP DEFENDERS</div>
    <div id="rank-list">WAITING...</div>
</div>

<div id="start-screen" class="overlay">
    <img src="https://raw.githubusercontent.com/sophosnotificationtest-max/jbrasillabs/main/logo.png" style="width:300px; margin-bottom:30px;">
    <div id="start-btn" class="btn-ui disabled">ESTABLISHING LINK...</div>
</div>

<div id="game-over-screen" class="overlay" style="display:none;">
    <h1 style="color: #f33; font-size: 24px; margin-bottom: 20px;">BREACH DETECTED</h1>
    <div class="btn-ui" onclick="location.reload()">REBOOT</div>
</div>

<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function sfx(f, t, d, v=0.05) {
    try {
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(v, audioCtx.currentTime); o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    } catch(e) {}
}

const bgCanvas = document.getElementById("bg-space"), sCtx = bgCanvas.getContext("2d");
const gCanvas = document.getElementById("game-layer"), gCtx = gCanvas.getContext("2d");
let score=0, lives=3, level=1, gameRunning=false, tick=0;
let enemies=[], bullets=[], stars=[], boss=null, overdrive=0, enemyBullets=[], powerups=[];
let mouseX=innerWidth/2, mouseY=innerHeight/2;
let tripleShotTimer = 0;
let userLoc="BR", userIP="0.0.0.0";

const ALIEN = [ [0,1,1,1,0],[1,1,0,1,1],[1,1,1,1,1],[0,1,0,1,0] ];
const BOSS_SHAPE = [
    [0,0,1,1,1,1,1,0,0],
    [0,1,1,1,1,1,1,1,0],
    [1,1,0,1,1,1,0,1,1],
    [1,1,1,1,1,1,1,1,1],
    [0,1,0,1,0,1,0,1,0]
];

function init() {
    bgCanvas.width = gCanvas.width = innerWidth;
    bgCanvas.height = gCanvas.height = innerHeight;
    stars = Array.from({length:200}, () => ({x:Math.random()*innerWidth, y:Math.random()*innerHeight, s:Math.random()*2}));
}
window.addEventListener("resize", init);
init();

async function fetchRank() {
    const list = document.getElementById("rank-list");
    try {
        const r = await fetch('https://jbrasillabs-1.onrender.com/leaderboard', { signal: AbortSignal.timeout(5000) });
        const d = await r.json();
        if(d && d.length > 0) {
            list.innerHTML = d.slice(0,8).map((x,i)=>`${i+1}º ${x.score} [${x.country||'BR'}]`).join("<br>");
        } else { list.innerText = "NO RECORDS"; }
    } catch(e) { list.innerText = "SOC OFFLINE"; }
}

function takeDamage() {
    lives = Math.max(0, lives - 0.4);
    document.getElementById("main-body").classList.add("shake");
    sfx(80, 'sawtooth', 0.2, 0.1);
    setTimeout(()=>document.getElementById("main-body").classList.remove("shake"), 200);
    if(lives <= 0) endGame();
}

function spawnPowerup(x, y) {
    const rand = Math.random();
    if (rand < 0.15) { 
        let type = 'shield';
        if (rand < 0.05) type = 'triple';
        else if (rand < 0.10) type = 'bomb';
        powerups.push({ x, y, type, speed: 2 });
    }
}

function loop() {
    tick++;
    sCtx.fillStyle = "#000"; sCtx.fillRect(0,0,innerWidth,innerHeight);
    stars.forEach(s => {
        s.y += s.s; if(s.y > innerHeight) s.y = 0;
        sCtx.fillStyle = "rgba(255,255,255,0.4)"; sCtx.fillRect(s.x, s.y, s.s, s.s);
    });

    gCtx.clearRect(0,0,innerWidth,innerHeight);

    if(gameRunning) {
        // Boss a cada 200 pontos
        if(score > 0 && score % 200 === 0 && !boss) {
            boss = { x: innerWidth/2, y: -100, hp: 120 * level, maxHp: 120 * level, size: 12, dir: 1 };
            sfx(100, 'square', 1);
        }

        // Inimigos contínuos
        if(tick % Math.max(5, 45 - (level * 4)) === 0) {
            enemies.push({ x: Math.random()*(innerWidth-40), y: -40, speed: 2 + (level*0.6) });
        }

        // Lógica Power-ups
        powerups.forEach((p, pi) => {
            p.y += p.speed;
            let colors = { shield: '#0f0', triple: '#0cf', bomb: '#f90' };
            gCtx.fillStyle = colors[p.type];
            gCtx.beginPath(); gCtx.arc(p.x, p.y, 10, 0, Math.PI*2); gCtx.fill();
            if (Math.hypot(p.x - mouseX, p.y - mouseY) < 35) {
                if (p.type === 'shield') { lives = Math.min(3, lives + 1); sfx(800, 'sine', 0.2); }
                if (p.type === 'triple') { tripleShotTimer = 500; sfx(1200, 'sine', 0.2); }
                if (p.type === 'bomb') { enemies = []; sfx(100, 'sawtooth', 0.5, 0.2); document.getElementById("main-body").classList.add("shake"); }
                powerups.splice(pi, 1);
            }
            if (p.y > innerHeight) powerups.splice(pi, 1);
        });

        // Lógica Boss
        if(boss) {
            boss.y = Math.min(boss.y + 1, 80);
            boss.x += (2 + level) * boss.dir;
            if(boss.x > innerWidth - 100 || boss.x < 100) boss.dir *= -1;
            BOSS_SHAPE.forEach((row, ri) => row.forEach((p, ci) => {
                if(p) {
                    gCtx.fillStyle = `hsl(${(tick%360)}, 100%, 50%)`;
                    gCtx.fillRect(boss.x + (ci*boss.size) - 50, boss.y + (ri*boss.size), boss.size, boss.size);
                }
            }));
            if(tick % Math.max(10, 45 - (level*5)) === 0) {
                enemyBullets.push({x: boss.x, y: boss.y + 60, speed: 5 + level});
                sfx(300, 'triangle', 0.1);
            }
            gCtx.fillStyle = "#330000"; gCtx.fillRect(innerWidth/2 - 100, 20, 200, 10);
            gCtx.fillStyle = "#ff0000"; gCtx.fillRect(innerWidth/2 - 100, 20, (boss.hp/boss.maxHp)*200, 10);
        }

        // Tiros Inimigos
        enemyBullets.forEach((eb, ebi) => {
            eb.y += eb.speed;
            gCtx.fillStyle = "#f00"; gCtx.fillRect(eb.x-4, eb.y, 8, 12);
            if(Math.hypot(eb.x - mouseX, eb.y - mouseY) < 30) { enemyBullets.splice(ebi, 1); takeDamage(); }
            if(eb.y > innerHeight) enemyBullets.splice(ebi, 1);
        });

        // Inimigos Comuns
        enemies.forEach((e, i) => {
            e.y += e.speed;
            gCtx.fillStyle = "#f33";
            ALIEN.forEach((row, ri) => row.forEach((p, ci) => { if(p) gCtx.fillRect(e.x+ci*8, e.y+ri*8, 8, 8); }));
            if(e.y > innerHeight) { enemies.splice(i, 1); takeDamage(); }
        });

        // Tiros Jogador
        bullets.forEach((b, bi) => {
            b.y -= 18;
            gCtx.fillStyle = (tripleShotTimer > 0) ? "#0cf" : (overdrive > 0 ? "#ff0" : "#0ff");
            gCtx.fillRect(b.x-2, b.y, 4, 15);
            
            if(boss && b.x > boss.x - 60 && b.x < boss.x + 60 && b.y < boss.y + 70) {
                boss.hp -= 2; bullets.splice(bi, 1);
                if(boss.hp <= 0) { score += 500; level++; boss = null; overdrive = 400; sfx(500, 'sine', 0.5); }
            }
            
            enemies.forEach((e, ei) => {
                if(b.x > e.x && b.x < e.x+40 && b.y > e.y && b.y < e.y+32) {
                    spawnPowerup(e.x + 20, e.y + 16);
                    score += 10; enemies.splice(ei, 1); bullets.splice(bi, 1);
                    sfx(600, 'triangle', 0.05);
                }
            });
            if(b.y < 0) bullets.splice(bi, 1);
        });

        if(overdrive > 0) overdrive--;
        if(tripleShotTimer > 0) tripleShotTimer--;
    }

    // Render Player
    gCtx.fillStyle = "#0f0";
    gCtx.fillRect(mouseX-20, mouseY, 40, 6); 
    gCtx.fillRect(mouseX-4, mouseY-12, 8, 12);

    // Update HUD
    document.getElementById("score-val").innerText = score.toString().padStart(4, '0');
    document.getElementById("level-val").innerText = level;
    document.getElementById("lives-val").innerText = Math.max(0, (lives*33.4)).toFixed(0) + "%";
    let status = tripleShotTimer > 0 ? "TRIPLE SHOT" : (overdrive > 0 ? "OVERDRIVE" : "STANDARD");
    document.getElementById("weapon-status").innerText = status;
    document.getElementById("weapon-status").style.color = tripleShotTimer > 0 ? "#0cf" : (overdrive > 0 ? "#ff0" : "#0ff");

    requestAnimationFrame(loop);
}

window.addEventListener("mousemove", e => { mouseX=e.clientX; mouseY=e.clientY; });
window.addEventListener("mousedown", () => {
    if(gameRunning) {
        if(tripleShotTimer > 0) {
            bullets.push({x: mouseX, y: mouseY}, {x: mouseX-20, y: mouseY+10}, {x: mouseX+20, y: mouseY+10});
        } else {
            bullets.push({x: mouseX, y: mouseY});
        }
        sfx(tripleShotTimer > 0 ? 1100 : 800, 'sine', 0.05);
    }
});

function startGame() {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    document.getElementById("start-screen").style.display="none";
    gameRunning=true;
    fetch('https://jbrasillabs-1.onrender.com/log', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ entry: `[SOC] START_GAME | IP: ${userIP}` }) }).catch(e=>{});
}

function endGame() {
    gameRunning = false;
    document.getElementById("game-over-screen").style.display="flex";
    fetch('https://jbrasillabs-1.onrender.com/score', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ score, country: userLoc }) }).catch(e=>{});
}

const unlock = () => {
    const b = document.getElementById("start-btn");
    b.innerText = "INITIALIZE SYSTEM";
    b.classList.remove("disabled");
    b.onclick = startGame;
};

fetch('https://api.ipify.org?format=json')
    .then(r => r.json())
    .then(d => {
        userIP = d.ip;
        return fetch(`https://ipapi.co/${d.ip}/json/`);
    })
    .then(r => r.json())
    .then(d => {
        userLoc = d.country_code || "BR";
        unlock();
    })
    .catch(() => unlock());

fetchRank();
loop();
</script>
</body>
</html>
