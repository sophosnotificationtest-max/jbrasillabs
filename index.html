<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>JBrasil Labs - Interstellar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Press Start 2P', cursive; cursor: none; color: #00ff00; }
        canvas { position: fixed; inset: 0; }
        #bg-space { z-index: 0; }
        #game-layer { z-index: 1; image-rendering: pixelated; }
        
        /* SHAKE EFFECT */
        .shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } }

        /* HUD & UI */
        .hud { position: fixed; top: 20px; left: 20px; z-index: 100; font-size: 10px; color: #fff; text-shadow: 0 0 8px #00ff00; }
        
        #leaderboard-fixed { position: fixed; top: 20px; right: 20px; z-index: 100; font-size: 9px; color: #4e9eff; background: rgba(0,0,0,0.6); padding: 15px; border: 1px solid rgba(78,158,255,0.3); text-align: right; backdrop-filter: blur(5px); }
        
        #geo-terminal { position: fixed; bottom: 80px; left: 20px; z-index: 200; font-size: 9px; background: rgba(0,0,0,0.8); padding: 12px; border-left: 3px solid #00ff00; backdrop-filter: blur(5px); min-width: 250px; }
        
        .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.85); z-index: 300; }
        #main-logo { width: 350px; margin-bottom: 30px; filter: drop-shadow(0 0 20px #00ff00); }
        
        .btn-ui { font-size: 12px; cursor: pointer; border: 3px solid #00ff00; padding: 15px 30px; background: transparent; color: #00ff00; transition: 0.3s; }
        .btn-ui:hover { background: #00ff00; color: #000; box-shadow: 0 0 30px #00ff00; }
        
        #footer-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.9); border-top: 1px solid #00ff0033; padding: 10px 20px; z-index: 100; font-size: 8px; opacity: 0.7; }
    </style>
</head>
<body id="main-body">

<canvas id="bg-space"></canvas>
<canvas id="game-layer"></canvas>

<div class="hud" id="game-hud">
    SCORE: <span id="score">0</span><br>
    SHIELD: <span id="lives">3</span>
</div>

<div id="leaderboard-fixed">
    <div style="font-weight: bold; margin-bottom: 8px; color: #00ff00;">TOP DEFENDERS</div>
    <div id="rank-list">CONNECTING...</div>
</div>

<div id="geo-terminal">
    > [SYSTEM] JBRASIL NEURAL CORE<br>
    <span id="location-data">> [SOC] SCANNING ORIGIN...</span>
</div>

<div id="start-screen" class="overlay">
    <img src="https://raw.githubusercontent.com/sophosnotificationtest-max/jbrasillabs/main/logo.png" id="main-logo">
    <div class="btn-ui" onclick="startGame()">INITIALIZE MISSION</div>
</div>

<div id="game-over-screen" class="overlay" style="display: none;">
    <h1 style="color: #ff3333; font-size: 26px; margin-bottom: 10px;">SYSTEM DOWN</h1>
    <div style="font-size: 10px; margin-bottom: 20px;">FINAL SCORE: <span id="final-score">0</span></div>
    <div class="btn-ui" style="border-color: #ff3333; color: #ff3333;" onclick="startGame()">REBOOT SYSTEM</div>
</div>

<div id="footer-bar">JBRASIL LABS // SECURE PROTOCOL // 2026</div>

<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const bgCanvas = document.getElementById("bg-space"), sCtx = bgCanvas.getContext("2d");
const gCanvas = document.getElementById("game-layer"), gCtx = gCanvas.getContext("2d");
let score = 0, lives = 3, gameRunning = false, tick = 0, userLoc = "UNKNOWN";
let galaxyStars = [], enemies = [], bullets = [], mouseTrail = [];
let mouseX = innerWidth/2, mouseY = innerHeight/2;

// --- API SYNC ---
async function fetchTop10() {
    try {
        const r = await fetch('https://jbrasillabs-1.onrender.com/leaderboard');
        const data = await r.json();
        let html = ""; data.slice(0, 10).forEach((d, i) => html += `${i+1}º ${d.score} PTS<br>`);
        document.getElementById("rank-list").innerHTML = html || "NO DATA";
    } catch(e) { document.getElementById("rank-list").innerText = "OFFLINE"; }
}

function sendLog(entry) {
    fetch('https://jbrasillabs-1.onrender.com/log', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ entry }) });
}

// --- AUDIO & GRAPHICS ---
function playSfx(f, t, d, v=0.05) {
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
    o.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + d);
    g.gain.setValueAtTime(v, audioCtx.currentTime); o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + d);
}

const INVADER_A = [[0,0,1,0,0,1,0,0],[0,0,0,1,1,0,0,0],[0,1,1,1,1,1,1,0],[1,1,0,1,1,0,1,1],[1,1,1,1,1,1,1,1],[0,0,1,0,0,1,0,0],[0,1,0,1,1,0,1,0],[1,0,1,0,0,1,0,1]];

function initGalaxy() {
    bgCanvas.width = gCanvas.width = innerWidth; bgCanvas.height = gCanvas.height = innerHeight;
    galaxyStars = [];
    for(let i=0; i<400; i++) galaxyStars.push({ angle: Math.random()*Math.PI*2, distance: Math.random()*innerWidth*0.6, arm: (Math.floor(Math.random()*3)*(Math.PI*2/3)), size: Math.random()*2, speed: 0.001+Math.random()*0.001 });
}

function gameLoop() {
    // Galáxia
    let gr = sCtx.createRadialGradient(innerWidth/2, innerHeight/2, 0, innerWidth/2, innerHeight/2, innerWidth);
    gr.addColorStop(0, '#000c24'); gr.addColorStop(1, '#000');
    sCtx.fillStyle = gr; sCtx.fillRect(0,0,innerWidth,innerHeight);
    galaxyStars.forEach(s => {
        s.angle += s.speed;
        const x = innerWidth/2 + Math.cos(s.angle + s.arm) * s.distance;
        const y = innerHeight/2 + Math.sin(s.angle + s.arm) * (s.distance * 0.5);
        sCtx.fillStyle = `rgba(255,255,255,0.6)`; sCtx.fillRect(x,y,s.size,s.size);
    });

    gCtx.clearRect(0,0,innerWidth,innerHeight);
    
    // Mouse Trail & Cursor
    if(tick % 3 === 0) mouseTrail.push({x: mouseX, y: mouseY, l: 1});
    mouseTrail.forEach((p, i) => { gCtx.fillStyle = `rgba(0,255,0,${p.l})`; gCtx.fillRect(p.x,p.y,3,3); p.l-=0.05; if(p.l<=0) mouseTrail.splice(i,1); });
    
    // Nave Jogador
    gCtx.fillStyle = "#0f0";
    [[0,0,0,1,1,0,0,0],[0,0,1,1,1,1,0,0],[1,1,1,1,1,1,1,1]].forEach((row, rIdx) => {
        row.forEach((col, cIdx) => { if(col) gCtx.fillRect(mouseX-20+(cIdx*5), mouseY-20+(rIdx*5), 5, 5); });
    });

    if(gameRunning) {
        tick++;
        if(tick % 50 === 0) enemies.push({x: Math.random()*(innerWidth-80)+40, y: -60, speed: 1.5+(score/2000), color: "#f33"});
        
        bullets.forEach((b, bi) => {
            b.y -= 15; gCtx.fillStyle = "#fff"; gCtx.fillRect(b.x, b.y, 4, 15);
            if(b.y < 0) bullets.splice(bi,1);
        });

        enemies.forEach((e, ei) => {
            e.y += e.speed;
            INVADER_A.forEach((row, rIdx) => {
                row.forEach((col, cIdx) => { if(col) { gCtx.fillStyle = e.color; gCtx.fillRect(e.x+(cIdx*5), e.y+(rIdx*5), 5, 5); }});
            });
            if(e.y > innerHeight) { 
                lives--; playSfx(100, 'square', 0.5); document.getElementById("main-body").classList.add("shake");
                setTimeout(()=>document.getElementById("main-body").classList.remove("shake"), 200);
                enemies.splice(ei,1); if(lives<=0) endGame(); 
            }
            bullets.forEach((b, bi) => {
                if(b.x > e.x && b.x < e.x+40 && b.y > e.y && b.y < e.y+40) { 
                    score+=10; playSfx(150, 'sawtooth', 0.1); enemies.splice(ei,1); bullets.splice(bi,1); 
                }
            });
        });
    }
    document.getElementById("score").innerText = score;
    document.getElementById("lives").innerText = lives;
    requestAnimationFrame(gameLoop);
}

function startGame() {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    document.getElementById("start-screen").style.display = "none";
    document.getElementById("game-over-screen").style.display = "none";
    score = 0; lives = 3; enemies = []; bullets = []; gameRunning = true;
    sendLog(`START: ${userLoc}`);
}

async function endGame() {
    gameRunning = false;
    document.getElementById("final-score").innerText = score;
    document.getElementById("game-over-screen").style.display = "flex";
    playSfx(60, 'sine', 1, 0.2);
    try {
        await fetch('https://jbrasillabs-1.onrender.com/score', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ score }) });
        fetchTop10();
    } catch(e) {}
}

window.addEventListener("mousemove", e => { mouseX = e.clientX; mouseY = e.clientY; });
window.addEventListener("mousedown", () => { if(gameRunning) { bullets.push({x: mouseX, y: mouseY-20}); playSfx(600, 'triangle', 0.1); } });
window.addEventListener("resize", initGalaxy);

fetch('https://ipapi.co/json/').then(r => r.json()).then(d => {
    userLoc = `${d.city}, ${d.country}`;
    document.getElementById("location-data").innerHTML = `> [GEO] ${userLoc.toUpperCase()}<br>> [IP] ${d.ip}`;
});

initGalaxy(); fetchTop10(); gameLoop();
</script>
</body>
</html>

