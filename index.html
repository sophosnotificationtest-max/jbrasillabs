<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>JBrasil Labs - Interstellar SOC Futurista</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Press Start 2P', cursive; cursor: none; color: #00ff00; }
        canvas { position: fixed; inset: 0; }
        #bg-space { z-index: 0; }
        #game-layer { z-index: 1; }
        
        .hud { position: fixed; top: 20px; left: 20px; z-index: 100; font-size: 10px; color: #fff; text-shadow: 0 0 10px #00ff00; line-height: 2; }
        #leaderboard-fixed { position: fixed; top: 20px; right: 20px; z-index: 100; font-size: 8px; color: #4e9eff; background: rgba(0,0,0,0.85); padding: 15px; border: 1px solid rgba(0,255,0,0.4); text-align: right; backdrop-filter: blur(5px); line-height: 2; }
        #geo-terminal { position: fixed; bottom: 80px; left: 20px; z-index: 200; font-size: 9px; background: rgba(0,0,0,0.8); padding: 12px; border-left: 3px solid #4e9eff; backdrop-filter: blur(5px); min-width: 280px; color: #4e9eff; }
        
        .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.92); z-index: 300; }
        #main-logo { width: 320px; margin-bottom: 40px; filter: drop-shadow(0 0 15px #00ff00); }
        
        .btn-ui { font-size: 12px; cursor: pointer; border: 2px solid #00ff00; padding: 15px 35px; background: transparent; color: #00ff00; transition: 0.4s; text-transform: uppercase; letter-spacing: 2px; }
        .btn-ui:hover:not(.disabled) { background: #00ff00; color: #000; box-shadow: 0 0 40px #00ff00; }
        .btn-ui.disabled { opacity: 0.3; cursor: wait; border-color: #444; color: #444; }
        
        #game-over-screen { display: none; background: radial-gradient(circle, rgba(40,0,0,1) 0%, rgba(0,0,0,1) 100%); }
    </style>
</head>
<body id="main-body">

<canvas id="bg-space"></canvas>
<canvas id="game-layer"></canvas>

<div class="hud">
    SCORE_ <span id="score">0000</span><br>
    SHIELD_ <span id="lives">100%</span><br>
    THREAT_ <span id="level">LVL_01</span>
</div>

<div id="leaderboard-fixed">
    <div style="font-weight: bold; margin-bottom: 10px; color: #00ff00;">TOP DEFENDERS</div>
    <div id="rank-list">INITIALIZING...</div>
</div>

<div id="geo-terminal">
    > [SYSTEM] NEURAL CORE ACTIVE<br>
    <span id="location-data">> [SOC] SCANNING SECTOR...</span>
</div>

<div id="start-screen" class="overlay">
    <img src="https://raw.githubusercontent.com/sophosnotificationtest-max/jbrasillabs/main/logo.png" id="main-logo">
    <div id="start-btn" class="btn-ui disabled">WAITING SYNC...</div>
</div>

<div id="game-over-screen" class="overlay">
    <h1 style="color: #ff3333; font-size: 30px; margin-bottom: 20px; letter-spacing: 5px;">SYSTEM BREACH</h1>
    <div style="font-size: 12px; margin-bottom: 30px;">FINAL SCORE: <span id="final-score">0</span></div>
    <div class="btn-ui" style="border-color: #ff3333; color: #ff3333;" onclick="location.reload()">REBOOT CORE</div>
</div>

<script>
// --- AUDIO ENGINE ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSfx(freq, type, duration, vol=0.1) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + duration);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + duration);
}

// --- CORE VARS ---
const bgCanvas = document.getElementById("bg-space"), sCtx = bgCanvas.getContext("2d");
const gCanvas = document.getElementById("game-layer"), gCtx = gCanvas.getContext("2d");
let score = 0, lives = 3, gameRunning = false, tick = 0;
let userLoc = "BR", userIP = "0.0.0.0", userCountry = "BRAZIL";
let galaxyStars = [], enemies = [], bullets = [], mouseTrail = [];
let mouseX = innerWidth/2, mouseY = innerHeight/2;

// --- API SYNC ---
async function fetchTop10() {
    try {
        const r = await fetch('https://jbrasillabs-1.onrender.com/leaderboard');
        const data = await r.json();
        let html = ""; 
        data.slice(0, 10).forEach((d, i) => html += `${i+1}. ${d.score.toString().padStart(5, '0')} [${d.country || 'BR'}]<br>`);
        document.getElementById("rank-list").innerHTML = html || "EMPTY SECTOR";
    } catch(e) { document.getElementById("rank-list").innerText = "OFFLINE"; }
}

function sendLog(msg) {
    fetch('https://jbrasillabs-1.onrender.com/log', { 
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({ entry: `[SOC] ${msg} | IP: ${userIP} [${userLoc}]` }) 
    }).catch(e => {});
}

// --- GRAPHICS ---
function initGalaxy() {
    bgCanvas.width = gCanvas.width = innerWidth; bgCanvas.height = gCanvas.height = innerHeight;
    galaxyStars = [];
    for(let i=0; i<400; i++) galaxyStars.push({
        angle: Math.random() * Math.PI * 2,
        distance: Math.random() * innerWidth * 0.7,
        arm: (Math.floor(Math.random() * 3) * (Math.PI * 2 / 3)),
        size: Math.random() * 2,
        speed: 0.0005 + Math.random() * 0.001
    });
}

function drawEntity(x, y, size, color, rot) {
    gCtx.save();
    gCtx.translate(x, y);
    gCtx.rotate(rot);
    gCtx.strokeStyle = color;
    gCtx.lineWidth = 2;
    gCtx.beginPath();
    // Forma Futurista: Diamante com núcleo
    gCtx.moveTo(0, -size);
    gCtx.lineTo(size, 0);
    gCtx.lineTo(0, size);
    gCtx.lineTo(-size, 0);
    gCtx.closePath();
    gCtx.stroke();
    // Brilho Interno
    gCtx.fillStyle = color;
    gCtx.globalAlpha = 0.3;
    gCtx.fillRect(-size/4, -size/4, size/2, size/2);
    gCtx.restore();
}

function gameLoop() {
    // Galáxia Escura Profunda
    sCtx.fillStyle = '#000208';
    sCtx.fillRect(0,0,innerWidth,innerHeight);
    let grad = sCtx.createRadialGradient(innerWidth/2, innerHeight/2, 0, innerWidth/2, innerHeight/2, innerWidth*0.8);
    grad.addColorStop(0, 'rgba(0, 40, 80, 0.15)');
    grad.addColorStop(1, 'transparent');
    sCtx.fillStyle = grad; sCtx.fillRect(0,0,innerWidth,innerHeight);

    galaxyStars.forEach(s => {
        s.angle += s.speed * (1 + score/3000);
        const x = innerWidth/2 + Math.cos(s.angle + s.arm) * s.distance;
        const y = innerHeight/2 + Math.sin(s.angle + s.arm) * (s.distance * 0.5);
        sCtx.fillStyle = "rgba(255, 255, 255, 0.5)";
        sCtx.fillRect(x, y, s.size, s.size);
    });

    gCtx.clearRect(0,0,innerWidth,innerHeight);
    
    // Trail de Partículas
    if(tick % 2 === 0) mouseTrail.push({x: mouseX, y: mouseY, l: 1});
    mouseTrail.forEach((p, i) => {
        gCtx.fillStyle = `rgba(0, 255, 255, ${p.l})`;
        gCtx.fillRect(p.x, p.y, 2, 2);
        p.l -= 0.04; if(p.l <= 0) mouseTrail.splice(i, 1);
    });

    // Cursor Futurista (Crosshair)
    gCtx.strokeStyle = "#0ff"; gCtx.lineWidth = 1;
    gCtx.beginPath();
    gCtx.arc(mouseX, mouseY, 15, 0, Math.PI*2);
    gCtx.moveTo(mouseX-20, mouseY); gCtx.lineTo(mouseX+20, mouseY);
    gCtx.moveTo(mouseX, mouseY-20); gCtx.lineTo(mouseX, mouseY+20);
    gCtx.stroke();

    if(gameRunning) {
        tick++;
        let lvl = Math.floor(score/500) + 1;
        document.getElementById("level").innerText = `LVL_${lvl.toString().padStart(2, '0')}`;
        
        if(tick % Math.max(15, 50 - lvl*4) === 0) {
            enemies.push({x: Math.random()*innerWidth, y: -50, speed: 2 + lvl*0.6, rot: 0, size: 20 + Math.random()*10});
        }

        bullets.forEach((b, bi) => {
            b.y -= 18;
            gCtx.fillStyle = "#fff"; gCtx.shadowBlur = 10; gCtx.shadowColor = "#0ff";
            gCtx.fillRect(b.x-1, b.y, 3, 20);
            gCtx.shadowBlur = 0;
            if(b.y < 0) bullets.splice(bi, 1);
        });

        enemies.forEach((e, ei) => {
            e.y += e.speed; e.rot += 0.05;
            drawEntity(e.x, e.y, e.size, "#f33", e.rot);
            
            if(e.y > innerHeight) {
                lives--; playSfx(80, 'square', 0.4, 0.2);
                document.body.style.backgroundColor = "#200";
                setTimeout(()=> document.body.style.backgroundColor = "#000", 100);
                enemies.splice(ei, 1); 
                document.getElementById("lives").innerText = (lives*33.3).toFixed(0) + "%";
                if(lives <= 0) endGame();
            }

            bullets.forEach((b, bi) => {
                let dist = Math.hypot(b.x - e.x, b.y - e.y);
                if(dist < e.size) {
                    score += 10; playSfx(200, 'sawtooth', 0.1, 0.1);
                    enemies.splice(ei, 1); bullets.splice(bi, 1);
                }
            });
        });
    }
    document.getElementById("score").innerText = score.toString().padStart(4, '0');
    requestAnimationFrame(gameLoop);
}

function startGame() {
    if(document.getElementById("start-btn").classList.contains("disabled")) return;
    document.getElementById("start-screen").style.display = "none";
    score = 0; lives = 3; enemies = []; bullets = []; gameRunning = true;
    playSfx(400, 'sine', 0.5);
    sendLog(`LEVEL_START`);
}

async function endGame() {
    gameRunning = false;
    document.getElementById("final-score").innerText = score;
    document.getElementById("game-over-screen").style.display = "flex";
    playSfx(50, 'sine', 1, 0.3);
    try {
        await fetch('https://jbrasillabs-1.onrender.com/score', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ score, country: userLoc }) 
        });
        fetchTop10();
    } catch(e) {}
}

window.addEventListener("mousemove", e => { mouseX = e.clientX; mouseY = e.clientY; });
window.addEventListener("mousedown", () => { 
    if(gameRunning) {
        bullets.push({x: mouseX, y: mouseY}); 
        playSfx(800, 'triangle', 0.08, 0.05);
    } 
});
window.addEventListener("resize", initGalaxy);

// --- SYNC SYSTEM ---
const unlock = () => {
    const btn = document.getElementById("start-btn");
    btn.innerText = "INITIALIZE DEFENSE";
    btn.classList.remove("disabled");
    btn.onclick = startGame;
};

setTimeout(unlock, 3000); // Fail-safe 3s

fetch('https://api.ipify.org?format=json')
    .then(r => r.json())
    .then(d => {
        userIP = d.ip;
        fetch(`https://ipapi.co/${d.ip}/json/`).then(r2 => r2.json()).then(d2 => {
            userLoc = d2.country_code || "BR";
            userCountry = d2.country_name || "BRAZIL";
            document.getElementById("location-data").innerHTML = `> [GEO] ${userCountry.toUpperCase()}<br>> [IP] ${userIP}`;
            unlock();
        });
    }).catch(unlock);

initGalaxy(); fetchTop10(); gameLoop();
</script>
</body>
</html>
